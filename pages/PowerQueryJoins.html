<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Purchases vs Payments Join Visualizer</title>
  <style>
    :root {
      --bg: linear-gradient(180deg, #f8fafc 0%, #f1f5f9 100%);
      --panel: #ffffff;
      --ink: #0f172a;
      --muted: #64748b;
      --shadow: rgba(15, 23, 42, 0.08);
      --border: #e2e8f0;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg);
      color: var(--ink);
      min-height: 100vh;
      padding-bottom: 3rem;
    }
    header {
      text-align: center;
      padding: 2rem 1rem 1.5rem;
    }
    h1 { margin: 0; font-size: 2.2rem; color: #1e293b; }
    .subtitle { margin-top: 0.5rem; color: var(--muted); font-size: 1.1rem; }
    
    /* MAIN LAYOUT GRID */
    .layout {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 1.5rem;
      display: grid;
      /* Split top section into two equal halves */
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
      align-items: stretch;
    }

    .panel {
      background: var(--panel);
      border-radius: 16px;
      box-shadow: 0 4px 6px -1px var(--shadow), 0 2px 4px -1px var(--shadow);
      border: 1px solid var(--border);
      padding: 1.5rem;
      height: 100%;
    }

    /* --- LEFT COLUMN: Controls + SQL --- */
    .controls-panel {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .field { display: flex; flex-direction: column; gap: 0.5rem; }
    label { color: var(--muted); font-weight: 600; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.05em; }
    
    select {
      padding: 0.75rem;
      border-radius: 8px;
      border: 1px solid #cbd5e1;
      font-size: 1rem;
      background: #f8fafc;
      color: #334155;
      cursor: pointer;
      width: 100%;
    }
    select:focus { outline: 2px solid #2563eb; border-color: transparent; }

    /* Logic Box */
    .question-box {
      background: #eff6ff;
      border-left: 4px solid #3b82f6;
      padding: 1rem;
      border-radius: 0 8px 8px 0;
    }
    .question-text { font-weight: 700; color: #1e3a8a; margin: 0 0 0.25rem 0; font-size: 1.1rem; }
    .answer-text { color: #334155; line-height: 1.5; margin: 0; font-size: 0.95rem; }
    
    .pill {
      display: inline-block;
      background: #fff7ed;
      color: #c2410c;
      padding: 0.25rem 0.75rem;
      border-radius: 99px;
      font-weight: 700;
      font-size: 0.85rem;
      border: 1px solid #ffedd5;
      margin-top: 0.75rem;
    }

    /* SQL Box */
    .sql-wrapper h3 { margin: 0 0 0.5rem 0; font-size: 0.9rem; color: var(--muted); text-transform: uppercase; }
    .sql-container {
      background: #1e293b;
      color: #e2e8f0;
      padding: 1rem;
      border-radius: 8px;
      font-family: 'Cascadia Code', Consolas, monospace;
      font-size: 0.9rem;
      line-height: 1.4;
      white-space: pre-wrap;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
    }

    /* --- RIGHT COLUMN: Venn Visual --- */
    .viz-panel {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background-color: #FFFDE7; 
      border-color: rgba(0,0,0,0.05);
    }

    svg { 
      width: 100%; 
      height: 100%;
      max-height: 400px;
      display: block; 
    }

    /* SVG Styles */
    .circle-base { fill: #ffffff; stroke: #94a3b8; stroke-width: 2; stroke-dasharray: 6, 4; }
    .svg-label { font-family: sans-serif; font-weight: 700; fill: #64748b; font-size: 16px; text-transform: uppercase; pointer-events: none; user-select: none; }
    .highlight-shape { fill: rgba(249, 115, 22, 0.85); opacity: 0; transition: opacity 0.4s ease; pointer-events: none; }
    .highlight-shape.active { opacity: 1; }

    .legend { margin-top: 1rem; display: flex; gap: 1.5rem; font-size: 0.9rem; color: #64748b; font-weight: 500; }
    .legend-item { display: flex; align-items: center; gap: 0.5rem; }
    .dot { width: 12px; height: 12px; border-radius: 50%; }
    .dot.white { background: #fff; border: 1px dashed #94a3b8; }
    .dot.orange { background: rgba(249, 115, 22, 0.85); }


    /* --- BOTTOM SECTION: TABLES --- */
    .tables-row {
      grid-column: 1 / -1;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
      margin-top: 1.5rem;
    }

    .table-card {
      background: var(--panel);
      border-radius: 12px;
      border: 1px solid var(--border);
      padding: 1.25rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.03);
    }
    
    .table-card h3 { margin: 0 0 1rem 0; font-size: 1.1rem; color: #334155; }

    /* Result Table (Full Width) */
    .result-row {
      grid-column: 1 / -1;
      margin-top: 1.5rem;
    }
    .result-card {
      background: #fff;
      border-radius: 12px;
      border: 1px solid #fed7aa;
      padding: 1.5rem;
      box-shadow: 0 4px 12px rgba(249, 115, 22, 0.08);
    }
    .result-card h3 { color: #c2410c; margin: 0 0 1rem 0; font-size: 1.25rem; }

    table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    th { background: #f1f5f9; color: #475569; font-weight: 600; text-align: left; padding: 0.75rem; border-bottom: 2px solid #e2e8f0; }
    td { padding: 0.75rem; border-bottom: 1px solid #f1f5f9; color: #334155; }
    tr:last-child td { border-bottom: none; }
    
    .result-table th { background: #ffedd5; color: #9a3412; border-bottom: 2px solid #fdba74; }

    @media (max-width: 900px) {
      .layout { grid-template-columns: 1fr; }
      .tables-row { grid-template-columns: 1fr; }
    }
    .back-row { display: flex; justify-content: flex-start; margin-bottom: .4rem; }
    .back-link { 
      display: inline-flex; align-items: center; gap: .45rem; 
      padding: .55rem 1.1rem; border-radius: 999px; 
      background: rgba(96,165,250,.15); color: #10b981; 
      text-decoration: none; font-weight: 700; letter-spacing: .01em;
      transition: background .2s ease, transform .2s ease;
    }
    .back-link:hover { background: rgba(96,165,250,.25); transform: translateY(-2px); }
    
  </style>
</head>
<body>
    <div class="back-row">
      <a class="back-link" href="../index.html">&#8592; Back to Power BI Infographics</a>
    </div>

<header>
  <h1>Purchases vs. Payments</h1>
  <p class="subtitle">Visualizing accounting data relationships with Power Query Joins</p>
</header>

<div class="layout">
  
  <aside class="panel controls-panel">
    
    <div class="field">
      <label for="scenarioSelect">Select a Business Question</label>
      <select id="scenarioSelect">
        <option value="inner">1. Purchases which are paid? (Inner Join)</option>
        <option value="leftAnti">2. Unpaid Purchases? (Left Anti Join)</option>
        <option value="rightAnti">3. Payments Unrelated to Purchases? (Right Anti)</option>
        <option value="left">4. Purchases data with Payments? (Left Outer)</option>
        <option value="right">5. Payments data with Purchases? (Right Outer)</option>
        <option value="full">6. Everything (Full Outer Join)</option>
      </select>
    </div>

    <div class="question-box">
      <p class="question-text" id="qText">Which purchases have been paid?</p>
      <p class="answer-text" id="aText">This join lists only the purchases that have a matching record in the Payments table.</p>
      <span class="pill" id="rowCountPill">0 rows returned</span>
    </div>

    <div class="sql-wrapper">
      <h3>SQL Equivalent</h3>
      <div class="sql-container" id="sqlOutput"></div>
    </div>

  </aside>

  <section class="panel viz-panel">
    <svg viewBox="0 0 400 300" preserveAspectRatio="xMidYMid meet">
      <defs>
        <circle id="leftCircle" cx="140" cy="150" r="90" />
        <circle id="rightCircle" cx="260" cy="150" r="90" />
        
        <mask id="maskLeftAnti">
          <rect width="100%" height="100%" fill="white"/>
          <use href="#rightCircle" fill="black"/>
        </mask>

        <mask id="maskRightAnti">
          <rect width="100%" height="100%" fill="white"/>
          <use href="#leftCircle" fill="black"/>
        </mask>

        <clipPath id="clipInteract">
          <use href="#rightCircle"/>
        </clipPath>
      </defs>

      <use href="#leftCircle" class="circle-base" />
      <use href="#rightCircle" class="circle-base" />

      <use href="#leftCircle" class="highlight-shape" id="hl-left" />
      <use href="#rightCircle" class="highlight-shape" id="hl-right" />
      <use href="#leftCircle" class="highlight-shape" id="hl-inner" clip-path="url(#clipInteract)" />
      <use href="#leftCircle" class="highlight-shape" id="hl-leftAnti" mask="url(#maskLeftAnti)" />
      <use href="#rightCircle" class="highlight-shape" id="hl-rightAnti" mask="url(#maskRightAnti)" />

      <text x="80" y="155" class="svg-label">Purchases</text>
      <text x="270" y="155" class="svg-label">Payments</text>
    </svg>
    
    <div class="legend">
      <span class="legend-item"><span class="dot white"></span> Data Table</span>
      <span class="legend-item"><span class="dot orange"></span> Included in Result</span>
    </div>
  </section>

  <div class="tables-row">
    <div class="table-card">
      <h3>Purchases (Left Table)</h3>
      <div id="leftTableContainer"></div>
    </div>
    <div class="table-card">
      <h3>Payments (Right Table)</h3>
      <div id="rightTableContainer"></div>
    </div>
  </div>
  
  <div class="result-row">
    <div class="result-card">
      <h3 id="resultHeader">Result Table</h3>
      <div id="resultTableContainer"></div>
    </div>
  </div>

</div>

<script>
  // --- DATA & LOGIC ---
  
  // UPDATED: 'ID' -> 'PurchaseID'
  const purchases = [
    { PurchaseID: 'PUR-001', Date: '2023-12-01', Vendor: 'ABC Corp', Amount: 1000 },
    { PurchaseID: 'PUR-002', Date: '2023-12-05', Vendor: 'XYZ Ltd',  Amount: 500  },
    { PurchaseID: 'PUR-003', Date: '2023-12-10', Vendor: 'ABC Corp', Amount: 2000 },
    { PurchaseID: 'PUR-004', Date: '2023-12-12', Vendor: 'Tech Sol', Amount: 750  }
  ];

  // UPDATED: 'PurchaseID' -> 'DocID' (The foreign key)
  const payments = [
    { PayID: 'PAY-101', DocID: 'PUR-001', Date: '2023-12-15', Amount: 1000 },
    { PayID: 'PAY-102', DocID: 'PUR-003', Date: '2023-12-20', Amount: 2000 },
    { PayID: 'PAY-103', DocID: 'EXP-999', Date: '2023-12-25', Amount: 150  }
  ];

  const scenarios = {
    inner: {
      question: "1. Purchases which are paid?",
      desc: "Inner Join: Returns records that have matching values in both tables.",
      highlight: ['hl-inner']
    },
    leftAnti: {
      question: "2. Unpaid Purchases?",
      desc: "Left Anti Join: Returns rows from the Left table (Purchases) that have NO match in the Right table.",
      highlight: ['hl-leftAnti']
    },
    rightAnti: {
      question: "3. Payments Unrelated to Purchases?",
      desc: "Right Anti Join: Returns rows from the Right table (Payments) that have NO match in the Left table.",
      highlight: ['hl-rightAnti']
    },
    left: {
      question: "4. Purchases data with Payments?",
      desc: "Left Outer Join: Returns all rows from the Left table, and the matching rows from the Right table.",
      highlight: ['hl-left']
    },
    right: {
      question: "5. Payments data with Purchases?",
      desc: "Right Outer Join: Returns all rows from the Right table, and the matching rows from the Left table.",
      highlight: ['hl-right']
    },
    full: {
      question: "6. Everything",
      desc: "Full Outer Join: Returns all rows when there is a match in EITHER left or right table.",
      highlight: ['hl-left', 'hl-rightAnti']
    }
  };

  function renderTable(data, containerId, columns, className='') {
    const table = document.createElement('table');
    if(className) table.classList.add(className);
    
    const thead = table.createTHead();
    const row = thead.insertRow();
    columns.forEach(col => {
      const th = document.createElement('th');
      th.textContent = col;
      row.appendChild(th);
    });

    const tbody = table.createTBody();
    data.forEach(item => {
      const r = tbody.insertRow();
      columns.forEach(col => {
        const cell = r.insertCell();
        cell.textContent = item[col] !== undefined && item[col] !== null ? item[col] : '-';
      });
    });

    const container = document.getElementById(containerId);
    container.innerHTML = '';
    container.appendChild(table);
  }

  function getCombinedData(type) {
    const results = [];
    const usedPayIDs = new Set();
    
    purchases.forEach(pur => {
      // UPDATED LOGIC: Join where payments.DocID == purchases.PurchaseID
      const matches = payments.filter(pay => pay.DocID === pur.PurchaseID);
      
      if (matches.length > 0) {
        // MATCH FOUND
        matches.forEach(pay => {
          usedPayIDs.add(pay.PayID);
          if (['inner', 'left', 'right', 'full'].includes(type)) {
            results.push({ 
              PurchaseID: pur.PurchaseID, 
              Date: pur.Date, 
              Vendor: pur.Vendor, 
              Amount: pur.Amount, 
              PayID: pay.PayID, 
              DocID: pay.DocID, // Include for clarity
              PayDate: pay.Date, 
              PayAmount: pay.Amount
            });
          }
        });
      } else {
        // NO MATCH FOUND
        if (['left', 'leftAnti', 'full'].includes(type)) {
          results.push({ 
            PurchaseID: pur.PurchaseID, 
            Date: pur.Date, 
            Vendor: pur.Vendor, 
            Amount: pur.Amount, 
            PayID: null,
            DocID: null, 
            PayDate: null, 
            PayAmount: null 
          });
        }
      }
    });

    // Handle Orphans in Right Table
    if (['right', 'rightAnti', 'full'].includes(type)) {
      payments.forEach(pay => {
        if (!usedPayIDs.has(pay.PayID)) {
          results.push({ 
            PurchaseID: null, 
            Date: null, 
            Vendor: null, 
            Amount: null, 
            PayID: pay.PayID,
            DocID: pay.DocID, 
            PayDate: pay.Date, 
            PayAmount: pay.Amount 
          });
        }
      });
    }

    return results;
  }

  function updateVisuals(type) {
    document.querySelectorAll('.highlight-shape').forEach(el => el.classList.remove('active'));
    
    const config = scenarios[type];
    config.highlight.forEach(id => document.getElementById(id).classList.add('active'));

    document.getElementById('qText').textContent = config.question;
    document.getElementById('aText').textContent = config.desc;
    document.getElementById('resultHeader').textContent = "Result: " + config.question;

    // UPDATED SQL TO REFLECT NEW COLUMN NAMES
    let sql = "";
    if(type === 'inner') sql = `SELECT *\nFROM Purchases A\nINNER JOIN Payments B\nON A.PurchaseID = B.DocID`;
    else if(type === 'leftAnti') sql = `SELECT *\nFROM Purchases A\nLEFT JOIN Payments B\nON A.PurchaseID = B.DocID\nWHERE B.DocID IS NULL`;
    else if(type === 'rightAnti') sql = `SELECT *\nFROM Purchases A\nRIGHT JOIN Payments B\nON A.PurchaseID = B.DocID\nWHERE A.PurchaseID IS NULL`;
    else if(type === 'left') sql = `SELECT *\nFROM Purchases A\nLEFT OUTER JOIN Payments B\nON A.PurchaseID = B.DocID`;
    else if(type === 'right') sql = `SELECT *\nFROM Purchases A\nRIGHT OUTER JOIN Payments B\nON A.PurchaseID = B.DocID`;
    else if(type === 'full') sql = `SELECT *\nFROM Purchases A\nFULL OUTER JOIN Payments B\nON A.PurchaseID = B.DocID`;
    
    document.getElementById('sqlOutput').textContent = sql;

    const resData = getCombinedData(type);
    document.getElementById('rowCountPill').textContent = `${resData.length} row(s) returned`;

    // Map result object to Table Headers
    const resultDisplay = resData.map(r => ({
      'Pur. ID': r.PurchaseID,
      'Vendor': r.Vendor,
      'Pur. Amt': r.Amount,
      'Pay. ID': r.PayID,
      'Doc ID': r.DocID, // Added this column so we can see the join key
      'Pay. Amt': r.PayAmount
    }));
    
    renderTable(resultDisplay, 'resultTableContainer', ['Pur. ID', 'Vendor', 'Pur. Amt', 'Pay. ID', 'Doc ID', 'Pay. Amt'], 'result-table');
  }

  // UPDATED RENDER CALLS
  renderTable(purchases, 'leftTableContainer', ['PurchaseID', 'Date', 'Vendor', 'Amount']);
  renderTable(payments, 'rightTableContainer', ['PayID', 'DocID', 'Date', 'Amount']);

  document.getElementById('scenarioSelect').addEventListener('change', (e) => {
    updateVisuals(e.target.value);
  });

  updateVisuals('inner');

</script>

</body>
</html>
